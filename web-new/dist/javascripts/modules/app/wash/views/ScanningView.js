(function(e,t){define(["backbone","underscore","doT","utilities/StringUtil","IOBackendDevice","Configuration","Device","Environment","Internationalization","ui/TemplateFactory","app/collections/AppsCollection","app/wash/collections/AppsQueryResultCollection","app/AppService"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){console.log("ScanningView - File loaded.");var p,d=!1,v=e.View.extend({className:"w-app-wash-scanning",template:n.template(f.get("wash","wash-scanning")),initialize:function(){p=l.getInstance()},setProgress:function(e){this.$el.append(this.$("progress").detach().attr({value:e,max:100}))},queryAppInfo:function(e){this.$(".title").html(a.app.QUERYING),this.$(".desc").html(a.app.QUERYING_TIP);var n=[];t.each(e,function(e){var i=p.get(e.item);if(i&&!i.get("base_info").ignore_wash){var s=i.get("base_info").signature;s&&(s=s.split(","),s=t.map(s,function(e){return r.MD5(e.toUpperCase())}),n.push({packageName:e.item,md5:e.value,signature:s.join(","),title:i.get("base_info").name,isSysApp:i.isSystem}),i.set({fileMd5:e.value,signatures:s.join(",")},{silent:!0}))}});var f=JSON.stringify({sdkVersion:o.get("SDKVersion"),isRoot:o.get("isRoot"),apks:n});i.requestAsync({type:"post",url:s.actions.APP_WASH_SCAN,data:{id:"wandoujia_windows",udid:o.get("udid")||"",version:u.get("backendVersion"),token:r.MD5("wandoujia_windows"+s.enums.APP_WASH_AUTH_KEY+f),data:f},dataType:"json",success:function(e){d||(this.trigger("next",c.getInstance(e)),this.remove())}.bind(this),error:function(){this.trigger("error"),this.remove()}.bind(this)})},startQueryMD5:function(){d=!1;if(p.loading||p.syncing){var e=function(){!p.loading&&!p.syncing&&(this.startQueryMD5(),p.off("refresh",e))};p.on("refresh",e,this)}else{var n=p.getNormalApps();if(n.length===0)this.trigger("next",c.getInstance([])),this.remove();else{var r=t.uniqueId("app_wash_md5_");h.scanMD5Async(t.map(n,function(e){return e.get("base_info").package_name}),r).done(function(e){d||this.queryAppInfo(e.body.success)}.bind(this)).fail(function(){this.trigger("error"),this.remove()}.bind(this));var s=i.Backend.Device.onmessage({"data.channel":r},function(e){this.setProgress(e.current/e.total*90),(e.current>=e.total||d)&&i.Backend.Device.offmessage(s)},this)}}},render:function(){return this.$el.html(this.template({})),this},cancel:function(){d=!0,this.remove()}}),m=t.extend({getInstance:function(){return new v}});return m})})(this);