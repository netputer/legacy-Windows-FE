(function(e,t){define(["underscore","doT","jquery","Log","IOBackendDevice","ui/Panel","ui/AlertWindow","Environment","WindowController","Device","Configuration","Internationalization","ui/TemplateFactory","ui/behavior/ButtonSetMixin","utilities/StringUtil","music/iTunes/iTunesData"],function(t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){console.log("iTunes ImportView - File Loaded");var g=e.alert,y=h.music,b="import-audios-progress",w="create-playlist-progress",E,S,x=o.extend({className:o.prototype.className+" w-iTunes-import-panel",initialize:function(){x.__super__.initialize.call(this);var e=[{$button:r("<button/>").addClass("import cancel").html(h.common.CANCEL),eventName:"import"}];this.title=y.ITUNES_IMPORT,this.width=430,this.height=270,this.draggable=!0,this.disableX=!0,this.buttons=e,this.$bodyContent=n.template(p.get("iTunes","iTunes-import"))({title:y.IMPORTING_TITLE})},render:function(){t.extend(this.events,x.__super__.events),this.delegateEvents(),x.__super__.render.call(this)},show:function(e){x.__super__.show.call(this),this.updatePanelTitleAndBtn(!1),this.$("."+b).remove(),this.$("."+w).remove(),this.data=e,this.importAudiosData={},this.createPlaylistData={};switch(parseInt(e.sourceType,10)){case c.enums.ITUNES_IMPORT_ALL:this.isCreatePlaylist=!0,this.importAudiosData={},this.createPlaylistData={},i({event:"debug.itunes.import",type:"all"});break;case c.enums.ITUNES_IMPORT_PLAYLIST:this.importAudiosData.itunes_id=e.iTunesIds.join(","),this.createPlaylistData.playlist_id=e.playlistIds.join(","),this.isCreatePlaylist=!0,i({event:"debug.itunes.import",type:"playlist"});break;case c.enums.ITUNES_IMPORT_AUDIOS:this.importAudiosData.itunes_id=e.iTunesIds.join(","),this.isCreatePlaylist=!1,i({event:"debug.itunes.import",type:"audios"})}this.startImportAudios()},updatePanelTitleAndBtn:function(e){e?(this.$("h3").html(y.IMPORT_COMPLETE),this.$(".import").removeClass("cancel").addClass("primary complete").html(h.common.OK)):(this.$("h3").html(y.IMPORTING_TITLE),this.$(".import").removeClass("complete").addClass("cancel").removeClass("primary").html(h.common.CANCEL))},renderProgress:function(e){var t=this.$("."+e.className);t.length&&t.remove();var r=n.template(p.get("iTunes","import-progress")),i=r(e);this.$(".progress-wrap").append(i)},startImportAudios:function(){var e=c.events.AUDIOS_IMPORT_MESSAGE;this.renderProgress({tip:h.music.IMPORTING_AUDIOS_TIP,className:b,current:0,isFaild:!1,total:this.data.songs||this.data.iTunesIds.length});var t=this.$("."+b+" .current"),n=this.$("."+b+" .total"),r=s.Backend.Device.onmessage({"data.channel":e},function(e){t.html(e.current),n.html(e.total),e.current===e.total&&s.Backend.Device.offmessage(r)},this);E=e,S=r,this.importAudiosData.session=e,f.blockWindowAsync(),m.importAudios(this.importAudiosData).done(this.importAudiosSuccess.bind(this)).fail(this.importAudiosFail.bind(this))},startCreatePlayList:function(){if(l.get("isMounted")){g(y.MOUNT_CANNOT_CREATE_PLAYLIST),this.createPlaylistFail({total:this.data.playlistIds&&this.data.playlistIds.length||0}),this.updatePanelTitleAndBtn(!0);return}var e=c.events.PLAYLIST_IMPORT_MESSAGE;this.renderProgress({tip:h.music.CREATING_PLAYLIST_TIP,className:w,current:0,isFaild:!1,total:this.data.play_lists&&this.data.play_lists.length||this.data.playlistIds&&this.data.playlistIds.length});var t=this.$("."+w+" .current"),n=this.$("."+w+" .total"),r=s.Backend.Device.onmessage({"data.channel":e},function(e){t.html(e.current),n.html(e.total),e.current===e.total&&s.Backend.Device.offmessage(r)},this);E=e,S=r,this.createPlaylistData.session=e,m.createPlaylist(this.createPlaylistData).done(this.createPlaylistSuccess.bind(this)).fail(this.createPlaylistFail.bind(this))},importAudiosSuccess:function(e){e.success&&e.success.length===e.total?(this.$("."+b+" .progress-tip").html(h.music.AUDIOS_IMPORT_COMPLETE),this.isCreatePlaylist?this.startCreatePlayList():this.updatePanelTitleAndBtn(!0)):this.importAudiosFail(e),f.releaseWindowAsync()},importAudiosFail:function(e){s.Backend.Device.offmessage(S);var t={tip:h.music.AUDIOS_IMPORT_FAILD,className:b,isFaild:!0,current:e.success&&e.success.length||0,total:e.total};this.renderProgress(t);var n=v.format(h.music.IMPORT_AUDIOS_FAILD_TIP,e.failed.length),i=[{$button:r("<button/>").addClass("primary retry").html(h.common.RETRY_TEXT),eventName:"RETRY"},{$button:r("<button/>").addClass("ignore").html(h.common.IGNORE),eventName:"IGNORE"},{$button:r("<button/>").html(h.common.CANCEL),eventName:"CANCEL"}],u=new o({title:h.common.DIALOG_TIP,width:360,disableX:!0,draggable:!0,buttons:i,$bodyContent:n});u.off("RETRY"),u.off("IGNORE"),u.off("CANCEL"),u.on("RETRY",function(){this.startImportAudios(),u.close()},this),u.on("IGNORE",function(){this.startCreatePlayList(),u.close()},this),u.on("CANCEL",function(){this.clickCancelImport(),u.close()},this),u.show(),s.Backend.Device.onmessage({"data.channel":c.events.DEVICE_STATE_CHANGE},function(e){r(".retry",this.$el).prop("disabled",!l.get("isConnected")||l.get("isWifi")||l.get("isInternet")),r(".ignore",this.$el).prop("disabled",!l.get("isConnected")||l.get("isWifi")||l.get("isInternet"))},u),f.releaseWindowAsync()},createPlaylistSuccess:function(e){this.updatePanelTitleAndBtn(!0),s.Backend.Device.offmessage(S);if(e.success&&e.success.length===e.total)this.$("."+w+" .progress-tip").html(h.music.CREATE_PLAYLIST_COMPLETE);else{this.createPlaylistFail(e);var t=v.format(h.music.CREATE_PLAYLIST_FAILD_TIP,e.failed.length),n=[{$button:r("<button/>").addClass("primary retry").html(h.common.RETRY_TEXT),eventName:"RETRY"},{$button:r("<button/>").html(h.common.CANCEL),eventName:"CANCEL"}],i=new o({title:h.common.DIALOG_TIP,width:360,disableX:!0,draggable:!0,buttons:n,$bodyContent:t});i.off("RETRY"),i.off("CANCEL"),i.on("RETRY",function(){m.createPlaylist(this.createPlaylistData).done(this.createPlaylistSuccess.bind(this)).fail(this.createPlaylistFail.bind(this)),i.close(),this.updatePanelTitleAndBtn(!1)},this),i.on("CANCEL",function(){i.close()},this),i.show(),s.Backend.Device.onmessage({"data.channel":c.events.DEVICE_STATE_CHANGE},function(e){r(".retry",this.$el).prop("disabled",!l.get("isConnected")||l.get("isWifi")||l.get("isInternet"))},i)}},createPlaylistFail:function(e){s.Backend.Device.offmessage(S);var t={tip:h.music.CREATE_PLAYLIST_FAILD,className:w,isFaild:!0,current:e.success&&e.success.length||0,total:e.total};this.renderProgress(t)},clickCancelImport:function(){var e={session:E};s.Backend.Device.offmessage(S),m.cancel(e),m.finish().always(this.closePanel.bind(this)),f.releaseWindowAsync()},clickCompleteImport:function(){m.finish().always(this.closePanel.bind(this))},closePanel:function(){this.close()},events:{"click .cancel":"clickCancelImport","click .complete":"clickCompleteImport"}}),T,N=t.extend({getInstance:function(){return T||(T=new x),T}});return N})})(this);