(function(e,t){define(["backbone","jquery","IOBackendDevice","Configuration"],function(n,r,i,s){function a(e){return/(\.|^){1}((wandou\.in)|(wandoujia\.com)){1}(\/|$){1}/.test(e)}function f(){var e=r("iframe"),n,i;for(i=e.length;i--;t)n=e[i],a(n.src)&&typeof n.contentWindow.updateUserStatus=="function"&&n.contentWindow.updateUserStatus({auth:u.get("auth")})}console.log("Account - File loaded.");var o=n.Model.extend({SINA:"sina",QZONE:"qzone",RENREN:"renren",TQQ:"tqq",QQ:"QQ",defaults:{isLogin:!1,auth:"",uid:"",userName:"",userMail:"",userAvatar:"",platforms:{}},initialize:function(){i.requestAsync(s.actions.ACCOUNT_INFO).done(function(e){e.state_code===200?(console.log("Account - Init account state success."),this.changeHandler(e.body)):console.error("Account - Init account state failed. Error info: "+e.state_line)}.bind(this))},isActive:function(e){return this.get("platforms")[e]===!0},bindAsync:function(e){var t=r.Deferred();return this.isActive(e)?t.resolve():i.requestAsync({url:s.actions.ACCOUNT_BIND,data:{plat:e===this.TQQ||e===this.QZONE?this.QQ:e},success:function(n){n.state_code===200?(console.log("Account - Bind "+e+" success."),t.resolve(n)):(console.error("Account - Bind "+e+" failed. Error info: "+n.state_line),t.reject(n))}}),t.promise()},loginAsync:function(e,t,n){var o=r.Deferred();return this.get("isLogin")?o.resolve():(n&&(n=n===this.TQQ||n===this.QZONE?this.QQ:n),i.requestAsync({url:s.actions.ACCOUNT_LOGIN,data:{title:e||"",source:t||"",platform:n||""},success:function(e){e.state_code===200?o.resolve(e):o.reject(e)}})),o.promise()},shareAsync:function(e){var t=r.Deferred();return i.requestAsync({url:s.actions.ACCOUNT_SHARE,data:e,success:function(e){e.state_code===200?t.resolve(e):t.reject(e)}}),t.promise()},changeHandler:function(e){if(e.auth){var n=e.member,r={};r[this.SINA]=n.activesina!==t&&parseInt(n.activesina,10)!==0,r[this.QZONE]=n.activeqq!==t&&parseInt(n.activeqq,10)!==0,r[this.TQQ]=n.activeqq!==t&&parseInt(n.activeqq,10)!==0,r[this.RENREN]=n.activerenren!==t&&parseInt(n.activerenren,10)!==0,this.set({auth:e.auth,uid:n.uid,userName:n.username,userMail:n.email,userAvatar:n.avatar,isLogin:!0,platforms:r})}else this.set(this.defaults)}}),u=new o;return u.on("change:isLogin",function(e,t){r("body").toggleClass("login",t),r("body").toggleClass("unlogin",!t)}),i.Backend.Device.onmessage({"data.channel":s.events.ACCOUNT_STATE_CHANGE},function(e){console.log("Account - Account state change."),u.changeHandler(e),f.call()}),e.Account=u,u})})(this);